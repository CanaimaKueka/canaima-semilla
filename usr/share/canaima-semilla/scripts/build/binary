#!/bin/sh

# lh_binary(1) - build binary images
# Copyright (C) 2006-2010 Daniel Baumann <daniel@debian.org>
#
# live-helper comes with ABSOLUTELY NO WARRANTY; for details see COPYING.
# This is free software, and you are welcome to redistribute it
# under certain conditions; see COPYING for details.

set -e

# Including common functions
. "${LH_BASE:-/usr/share/canaima-semilla}"/scripts/build.sh

# Setting static variables
DESCRIPTION="$(Echo 'build binary images')"
HELP=""
USAGE="${PROGRAM} [--force]"

Arguments "${@}"

# Reading configuration files
Read_conffiles config/all config/common config/bootstrap config/chroot config/binary config/source
Set_defaults

# Setup cleanup function
Setup_cleanup

# Preparing root filesystem
canaima-semilla binary_chroot ${*}

if [ "${LH_BUILD_WITH_CHROOT}" = "true" ]
then
	# Configuring chroot
	canaima-semilla chroot_devpts install ${*}
	canaima-semilla chroot_proc install ${*}
	canaima-semilla chroot_selinuxfs install ${*}
	canaima-semilla chroot_sysfs install ${*}
	canaima-semilla chroot_hosts install ${*}
	canaima-semilla chroot_resolv install ${*}
	canaima-semilla chroot_hostname install ${*}
	canaima-semilla chroot_sysv-rc install ${*}
	canaima-semilla chroot_upstart install ${*}
	canaima-semilla chroot_apt install-binary ${*}
	canaima-semilla chroot_sources install ${*}
fi

# Building root filesystem
canaima-semilla binary_rootfs ${*}
canaima-semilla binary_manifest ${*}
canaima-semilla binary_encryption ${*}

# Prepare images
canaima-semilla binary_local-packageslists ${*}
canaima-semilla binary_linux-image ${*}
canaima-semilla binary_debian-installer ${*}
canaima-semilla binary_memtest ${*}
canaima-semilla binary_grub ${*}
canaima-semilla binary_grub2 ${*}
canaima-semilla binary_syslinux ${*}
canaima-semilla binary_yaboot ${*}
canaima-semilla binary_silo ${*}
canaima-semilla binary_disk ${*}
canaima-semilla binary_win32-loader ${*}
canaima-semilla binary_includes ${*}
canaima-semilla binary_local-includes ${*}
canaima-semilla binary_local-hooks ${*}
canaima-semilla binary_checksums ${*}

if [ "${LH_BUILD_WITH_CHROOT}" != "true" ]
then
	canaima-semilla chroot_devpts install ${*}
	canaima-semilla chroot_proc install ${*}
	canaima-semilla chroot_selinuxfs install ${*}
	canaima-semilla chroot_sysfs install ${*}
fi

# Building images
canaima-semilla binary_iso ${*}
canaima-semilla binary_net ${*}
canaima-semilla binary_tar ${*}
canaima-semilla binary_usb ${*}
canaima-semilla binary_virtual-hdd ${*}

if [ "${LH_BUILD_WITH_CHROOT}" = "true" ]
then
	# Deconfiguring chroot
	rm -f .stage/chroot_sources
	canaima-semilla chroot_hostname remove ${*}
	canaima-semilla chroot_resolv remove ${*}
	canaima-semilla chroot_hosts remove ${*}
fi

canaima-semilla chroot_apt remove ${*}
canaima-semilla chroot_sysv-rc remove ${*}
canaima-semilla chroot_sysfs remove ${*}
canaima-semilla chroot_upstart remove ${*}
canaima-semilla chroot_selinuxfs remove ${*}
canaima-semilla chroot_proc remove ${*}
canaima-semilla chroot_devpts remove ${*}
